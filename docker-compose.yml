networks:
  frontend:
  backend:

volumes:
  postgres_data:
  redis_data:
  minio_data:

services:
  # ===================
  # Infrastructure
  # ===================
  postgres:
    image: postgres:16
    env_file: .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - backend
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    networks:
      - backend
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    env_file: .env
    volumes:
      - minio_data:/data
    ports:
      - '9000:9000'
      - '9001:9001'
    networks:
      - backend
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 10s
      timeout: 5s
      retries: 5

  # ===================
  # Apps (uncomment as needed)
  # ===================

  # --- v0.1: file, doc, chat, ai, web ---
  # file:
  #   build: ./apps/file
  #   env_file: .env
  #   volumes:
  #     - ./apps/file/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - redis
  #     - minio
  #   ports:
  #     - "3001:3000"
  #   networks:
  #     - backend

  # doc:
  #   build: ./apps/doc
  #   env_file: .env
  #   volumes:
  #     - ./apps/doc/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - file
  #   ports:
  #     - "3002:3000"
  #   networks:
  #     - backend

  # chat:
  #   build: ./apps/chat
  #   env_file: .env
  #   volumes:
  #     - ./apps/chat/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - redis
  #     - ai
  #   ports:
  #     - "3009:3000"
  #   networks:
  #     - backend

  # ai:
  #   build: ./apps/ai
  #   env_file: .env
  #   volumes:
  #     - ./apps/ai/src:/app/src:ro
  #   command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
  #   ports:
  #     - "8000:8000"
  #   networks:
  #     - backend

  web:
    build: ./apps/web
    env_file: .env
    volumes:
      - ./apps/web/src:/app/src:ro
      - ./apps/web/public:/app/public:ro
    command: npm run dev
    ports:
      - '3000:3000'
    networks:
      - frontend
      - backend

  # --- v0.3: db ---
  # db:
  #   build: ./apps/db
  #   env_file: .env
  #   volumes:
  #     - ./apps/db/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #   ports:
  #     - "3008:3000"
  #   networks:
  #     - backend

  # --- v0.4: browser ---
  # browser:
  #   build: ./apps/browser
  #   env_file: .env
  #   volumes:
  #     - ./apps/browser/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #   ports:
  #     - "3006:3000"
  #   networks:
  #     - backend

  # --- v0.5: sheet ---
  # sheet:
  #   build: ./apps/sheet
  #   env_file: .env
  #   volumes:
  #     - ./apps/sheet/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - file
  #   ports:
  #     - "3004:3000"
  #   networks:
  #     - backend

  # --- v0.6: slide ---
  # slide:
  #   build: ./apps/slide
  #   env_file: .env
  #   volumes:
  #     - ./apps/slide/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - file
  #   ports:
  #     - "3003:3000"
  #   networks:
  #     - backend

  # --- v0.7: gallery ---
  # gallery:
  #   build: ./apps/gallery
  #   env_file: .env
  #   volumes:
  #     - ./apps/gallery/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #     - file
  #     - minio
  #   ports:
  #     - "3005:3000"
  #   networks:
  #     - backend

  # --- v0.8: mail ---
  # mail:
  #   build: ./apps/mail
  #   env_file: .env
  #   volumes:
  #     - ./apps/mail/src:/app/src:ro
  #   command: npm run dev
  #   depends_on:
  #     - postgres
  #   ports:
  #     - "3007:3000"
  #   networks:
  #     - backend

  # --- nginx (uncomment when web is ready) ---
  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #   networks:
  #     - frontend
  #     - backend
  #   depends_on:
  #     - web
