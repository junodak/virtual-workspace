events {
    worker_connections 1024;
}

http {
    upstream web {
        server web:3000;
    }

    upstream file_api {
        server file:3000;
    }

    upstream doc_api {
        server doc:3000;
    }

    upstream slide_api {
        server slide:3000;
    }

    upstream sheet_api {
        server sheet:3000;
    }

    upstream gallery_api {
        server gallery:3000;
    }

    upstream browser_api {
        server browser:3000;
    }

    upstream mail_api {
        server mail:3000;
    }

    upstream db_api {
        server db:3000;
    }

    upstream chat_api {
        server chat:3000;
    }

    upstream ai_api {
        server ai:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # Frontend
        location / {
            proxy_pass http://web;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # API routes
        location /api/file {
            proxy_pass http://file_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/doc {
            proxy_pass http://doc_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/slide {
            proxy_pass http://slide_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/sheet {
            proxy_pass http://sheet_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/gallery {
            proxy_pass http://gallery_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/browser {
            proxy_pass http://browser_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/mail {
            proxy_pass http://mail_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/db {
            proxy_pass http://db_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/chat {
            proxy_pass http://chat_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            # SSE support
            proxy_buffering off;
            proxy_cache off;
        }

        location /api/ai {
            proxy_pass http://ai_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            # Streaming support
            proxy_buffering off;
            proxy_cache off;
        }
    }
}
